# T31-需求管理 E2E测试场景

## 测试环境

- 浏览器: Chrome/Firefox/Edge 最新版
- 后端服务: http://localhost:8080
- 前端服务: http://localhost:3000
- 测试工具: Cypress / Playwright / Selenium

## 前置条件

1. 后端服务正常运行
2. 数据库已初始化测试数据
3. 测试用户已创建(username: testuser, password: testpass)
4. 测试项目已创建(项目名: E2E测试项目)

## 测试场景

### 场景1: 编辑整体需求文档→版本保存→验证版本列表→下载

**步骤:**
1. 登录系统(testuser/testpass)
2. 进入项目详情页(E2E测试项目)
3. 点击"需求管理"Tab
4. 默认停留在"整体需求"Tab,验证显示只读模式
5. 点击"编辑"按钮进入编辑模式
6. 验证Markdown编辑器显示,工具栏可见
7. 编辑文档内容:
   ```markdown
   # E2E测试需求

   ## 功能需求
   - 功能点1
   - 功能点2

   ## 非功能需求
   - 性能要求
   - 安全要求
   ```
8. 点击"版本保存"按钮
9. 验证成功提示消息显示自动生成的文件名
   - 格式验证: `E2E测试项目_整体需求_YYYY-MM-DD_HHmmss.md`
   - 日期时间验证: 当前日期时间
10. 自动切回只读模式
11. 切换到"整体版本管理"Tab
12. 验证左栏"整体需求版本管理"显示新版本记录
    - 版本ID存在
    - 文件名正确
    - 创建时间正确
13. 点击下载按钮
14. 验证浏览器下载文件
15. 打开下载的.md文件,验证内容一致性

**预期结果:**
- ✅ 版本保存成功
- ✅ 文件名格式正确
- ✅ 版本列表显示新版本
- ✅ 下载文件内容正确

---

### 场景2: 导入Markdown文件→编辑→保存版本→验证版本列表更新

**步骤:**
1. 准备测试文件:`test_import.md`
   ```markdown
   # 导入测试

   这是从外部导入的Markdown文档。
   ```
2. 登录并进入"变更需求"Tab
3. 点击"编辑"按钮
4. 点击"导入"按钮
5. 选择`test_import.md`文件
6. 验证文件大小限制:
   - ≤5MB: 导入成功
   - >5MB: 显示错误提示"文件大小不能超过5MB"
7. 验证文件后缀:
   - .md后缀: 导入成功
   - 其他后缀: 显示错误提示
8. 导入成功后,验证编辑器内容更新为导入的文档
9. 继续编辑,追加内容:
   ```markdown
   ## 追加内容
   - 新增功能
   ```
10. 点击"版本保存"
11. 验证成功提示
12. 切换到"变更版本管理"Tab
13. 验证左栏"变更需求版本管理"显示新版本
14. 下载验证内容包含导入的内容+追加的内容

**预期结果:**
- ✅ 导入功能正常
- ✅ 文件大小验证生效
- ✅ 文件后缀验证生效
- ✅ 导入内容正确显示
- ✅ 编辑后保存版本成功

---

### 场景3: 多次保存版本→验证文件名时间戳递增且无冲突

**步骤:**
1. 登录并进入"整体测试观点"Tab
2. 点击"编辑"
3. 编辑内容,点击"版本保存"(第一次)
4. 记录生成的文件名:
   ```
   E2E测试项目_整体测试观点_2025-11-17_103001.md
   ```
5. 切回只读模式,再次点击"编辑"
6. 修改内容,再次点击"版本保存"(第二次)
7. 记录生成的文件名:
   ```
   E2E测试项目_整体测试观点_2025-11-17_103002.md
   ```
8. 重复步骤5-7,执行第三次版本保存
9. 记录生成的文件名:
   ```
   E2E测试项目_整体测试观点_2025-11-17_103005.md
   ```
10. 切换到"整体版本管理"Tab → 右栏
11. 验证3个版本记录都存在
12. 验证文件名时间戳递增:
    - 第二次 > 第一次
    - 第三次 > 第二次
13. 验证没有文件名冲突(所有文件名唯一)

**预期结果:**
- ✅ 时间戳自动递增
- ✅ 无文件名冲突
- ✅ 版本列表按创建时间倒序显示(最新的在最前)

---

### 场景4: 权限校验测试

**步骤:**
1. 创建测试项目"项目A"(创建人: admin)
2. 创建测试用户"user1"(非项目成员)
3. 使用user1登录
4. 尝试访问项目A的需求管理页面
   - URL: `/project/{项目A的ID}/requirements`
5. 验证显示403错误或权限拒绝提示
6. 使用admin登录
7. 进入项目A,添加user1为项目成员
8. 使用user1重新登录
9. 访问项目A的需求管理页面
10. 验证可以正常访问和编辑

**预期结果:**
- ✅ 非项目成员无法访问
- ✅ 项目成员可以正常访问

---

### 场景5: 编辑模式切换测试

**步骤:**
1. 登录并进入"变更测试观点"Tab
2. 验证默认只读模式:
   - 显示ReactMarkdown渲染的预览
   - 仅显示"编辑"按钮
   - 不显示工具栏
3. 点击"编辑"按钮
4. 验证进入编辑模式:
   - 显示MdEditor组件
   - 显示工具栏(加粗、斜体等)
   - 显示"保存"、"版本保存"、"导入"、"取消"按钮
5. 修改内容(记录原始内容):
   ```
   原始内容: # 变更测试观点\n\n原始段落
   ```
6. 修改为:
   ```
   修改内容: # 变更测试观点\n\n修改后的段落
   ```
7. 点击"取消"按钮
8. 验证切回只读模式
9. 验证内容恢复为原始内容(未保存修改)
10. 再次点击"编辑"
11. 修改内容
12. 点击"保存"按钮(非"版本保存")
13. 验证成功提示
14. 自动切回只读模式
15. 验证内容已更新(保存生效)
16. 验证版本列表无新增(仅更新数据库,未生成版本)

**预期结果:**
- ✅ 默认只读模式
- ✅ 编辑模式正常切换
- ✅ 取消按钮恢复原始内容
- ✅ 保存按钮更新数据库但不生成版本
- ✅ 版本保存生成版本记录

---

## 测试数据准备

### 1. 测试用户

```sql
-- 管理员
INSERT INTO users (username, nickname, password_hash, role, created_at)
VALUES ('admin', 'E2E管理员', '$2a$10$...', 'system_admin', NOW());

-- 项目成员
INSERT INTO users (username, nickname, password_hash, role, created_at)
VALUES ('testuser', 'E2E测试用户', '$2a$10$...', 'project_member', NOW());

-- 非项目成员
INSERT INTO users (username, nickname, password_hash, role, created_at)
VALUES ('outsider', '外部用户', '$2a$10$...', 'project_member', NOW());
```

### 2. 测试项目

```sql
INSERT INTO projects (name, description, created_by, created_at)
VALUES ('E2E测试项目', '用于E2E自动化测试', 1, NOW());
```

### 3. 测试文件

创建`test_import.md`:
```markdown
# 导入测试

这是从外部导入的Markdown文档。

## 章节1
内容1

## 章节2
内容2
```

创建`large_file.md`(超过5MB用于测试文件大小限制)

---

## 自动化测试脚本示例 (Cypress)

```javascript
describe('T31-需求管理版本功能', () => {
  beforeEach(() => {
    cy.login('testuser', 'testpass');
    cy.visit('/project/1/requirements');
  });

  it('场景1: 编辑→版本保存→下载', () => {
    // 进入编辑模式
    cy.contains('编辑').click();
    
    // 编辑内容
    cy.get('[data-testid="md-editor"]').clear().type('# E2E测试\n\n测试内容');
    
    // 版本保存
    cy.contains('版本保存').click();
    
    // 验证提示消息
    cy.contains(/E2E测试项目_整体需求_\d{4}-\d{2}-\d{2}_\d{6}\.md/).should('be.visible');
    
    // 切换到版本管理Tab
    cy.contains('整体版本管理').click();
    
    // 验证版本列表
    cy.get('table').contains('E2E测试项目_整体需求').should('exist');
    
    // 下载
    cy.contains('下载').first().click();
    
    // 验证下载(需要配置Cypress下载目录)
    cy.readFile('cypress/downloads/E2E测试项目_整体需求*.md').should('contain', '# E2E测试');
  });

  it('场景5: 编辑模式切换', () => {
    // 验证默认只读
    cy.get('[data-testid="markdown-preview"]').should('exist');
    cy.get('[data-testid="md-editor"]').should('not.exist');
    
    // 进入编辑模式
    cy.contains('编辑').click();
    cy.get('[data-testid="md-editor"]').should('exist');
    
    // 修改并取消
    cy.get('[data-testid="md-editor"]').clear().type('修改内容');
    cy.contains('取消').click();
    
    // 验证内容未保存
    cy.get('[data-testid="markdown-preview"]').should('not.contain', '修改内容');
  });
});
```

---

## 性能测试

### 1. 大文件编辑性能

- 测试1MB Markdown文档的编辑响应时间
- 目标: <100ms

### 2. 版本列表加载性能

- 测试100个版本记录的加载时间
- 目标: <500ms

### 3. 并发版本保存

- 模拟5个用户同时保存版本
- 验证无数据冲突

---

## 验收标准

- ✅ 所有5个测试场景通过
- ✅ 单元测试覆盖率≥80%
- ✅ E2E测试全部通过
- ✅ 无严重(Severity 1-2)Bug
- ✅ 文档完整(用户手册+API文档+测试报告)
- ✅ 性能测试达标

---

**测试执行时间**: 预计30-45分钟  
**测试执行人**: QA团队  
**测试环境**: Staging环境  
**测试日期**: 部署前1天
