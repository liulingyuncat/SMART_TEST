# =============================================================================
# SMART_TEST (webtest) - Production Docker Compose
#
# 生产环境容器编排配置
# 包含: webtest服务 + PostgreSQL数据库
#
# 环境准备：Docker 和 Docker Compose 已安装
# 1.创建一个工程文件夹，如 ~/smart_test
# 2.在该文件夹内复制 install.sh和docker-compose.yml 文件
# 3.执行安装脚本: ./install.sh(chmod +x install.sh)
# 4.拉取最新镜像:docker compose pull
# 5.运行在当前文件夹：docker compose up -d
#
# .env 文件示例:
#   DB_PASSWORD=your_secure_password
#   JWT_SECRET=your_jwt_secret_key
#   MCP_AUTH_TOKEN=your_mcp_token
#
# =============================================================================

version: '3.8'

services:
  # ---------------------------------------------------------------------------
  # webtest 主服务 (Web + MCP)
  # ---------------------------------------------------------------------------
  webtest:
    image: ghcr.io/liulingyuncat/smart_test-webtest:latest
    container_name: webtest
    restart: unless-stopped
    env_file:
      - .env
    ports:
      - "8443:8443"   # Web 服务 (HTTPS)
      - "16410:16410" # MCP 服务 (HTTP)
    environment:
      # 数据库配置
      - DB_TYPE=postgres
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_USER=webtest
      - DB_PASSWORD=${DB_PASSWORD:-webtest_default_pass_change_me}
      - DB_NAME=webtest
      - DB_MAX_OPEN_CONNS=25
      - DB_MAX_IDLE_CONNS=10
      # 应用配置
      - JWT_SECRET=${JWT_SECRET:-default_jwt_secret_please_change_in_production}
      - TZ=Asia/Shanghai
      # MCP 配置
      - MCP_AUTH_TOKEN=${MCP_AUTH_TOKEN:-default_mcp_token_change_me}
      - MCP_BACKEND_URL=https://localhost:8443
      # Playwright 配置
      - PLAYWRIGHT_EXECUTOR_URL=http://playwright-executor:53730
      # TLS 证书配置（容器内使用绝对路径）
      - CERT_FILE=/app/certs/server.crt
      - KEY_FILE=/app/certs/server.key
      # 提示词目录路径（容器内使用绝对路径）
      - PROMPTS_DIR=/app/internal/mcp/prompts
    volumes:
      # 持久化存储
      - ./storage:/app/storage
      # 注意：不再需要 Docker socket，使用 HTTP 调用 playwright-executor
    depends_on:
      postgres:
        condition: service_healthy
      playwright-executor:
        condition: service_healthy
    networks:
      - webtest-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8443/api/v1/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  # ---------------------------------------------------------------------------
  # PostgreSQL 数据库
  # ---------------------------------------------------------------------------
  postgres:
    image: postgres:16-alpine
    container_name: webtest-postgres
    restart: unless-stopped
    env_file:
      - .env
    environment:
      - POSTGRES_DB=webtest
      - POSTGRES_USER=webtest
      - POSTGRES_PASSWORD=${DB_PASSWORD:-webtest_default_pass_change_me}
      - TZ=Asia/Shanghai
    volumes:
      # 使用本地目录挂载，方便备份和管理
      - ./data/postgres:/var/lib/postgresql/data
    networks:
      - webtest-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U webtest -d webtest"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  # ---------------------------------------------------------------------------
  # Playwright 测试运行器 (run-server 模式)
  # ---------------------------------------------------------------------------
  playwright-runner:
    image: mcr.microsoft.com/playwright:v1.52.0-noble
    container_name: playwright-runner
    # 使用 Playwright 官方 run-server 模式
    command: >
      /bin/sh -c "
        npx -y playwright@1.52.0 run-server --port 3000 --host 0.0.0.0
      "
    restart: unless-stopped
    dns:
      - 8.8.8.8
      - 8.8.4.4
    extra_hosts:
      - "host.docker.internal:host-gateway"
    volumes:
      - ./scripts:/app/scripts:ro
    networks:
      - webtest-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  # ---------------------------------------------------------------------------
  # Playwright 脚本执行器 (Node.js HTTP 服务)
  # ---------------------------------------------------------------------------
  playwright-executor:
    image: ghcr.io/liulingyuncat/smart_test-playwright-executor:latest
    container_name: playwright-executor
    restart: unless-stopped
    dns:
      - 8.8.8.8
      - 8.8.4.4
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      - PLAYWRIGHT_WS=ws://playwright-runner:3000
      - PORT=53730
    depends_on:
      playwright-runner:
        condition: service_healthy
    networks:
      - webtest-network
    healthcheck:
      test: ["CMD", "node", "-e", "const http = require('http'); http.get('http://localhost:53730/health', (res) => { process.exit(res.statusCode === 200 ? 0 : 1); }).on('error', () => process.exit(1));"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

# -----------------------------------------------------------------------------
# 网络配置
# -----------------------------------------------------------------------------
networks:
  webtest-network:
    driver: bridge

# -----------------------------------------------------------------------------
# 数据卷配置
# -----------------------------------------------------------------------------
# 注意: 本配置使用本地目录挂载而非 Docker 命名卷
# 数据目录:
#   - ./data/postgres  PostgreSQL 数据库文件
#   - ./storage        应用数据 (附件、导出文件等)
