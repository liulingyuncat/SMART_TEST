# =============================================================================
# SMART_TEST (webtest) - Production Docker Compose
#
# 生产环境容器编排配置
# 包含: webtest服务 + PostgreSQL数据库
#
# 使用方法:
#   1. (可选) 创建 .env 文件设置自定义密码
#   2. docker-compose up -d
#
# .env 文件示例:
#   DB_PASSWORD=your_secure_password
#   JWT_SECRET=your_jwt_secret_key
#   MCP_AUTH_TOKEN=your_mcp_token
#
# 如不创建 .env 文件，将使用默认值（仅用于测试）
# =============================================================================

version: '3.8'

services:
  # ---------------------------------------------------------------------------
  # webtest 主服务 (Web + MCP)
  # ---------------------------------------------------------------------------
  webtest:
    image: ghcr.io/liulingyuncat/smart_test:latest
    container_name: webtest
    restart: unless-stopped
    env_file:
      - .env
    ports:
      - "8443:8443"   # Web 服务 (HTTPS)
      - "16410:16410" # MCP 服务 (HTTP)
    environment:
      # 数据库配置
      - DB_TYPE=postgres
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_USER=webtest
      - DB_PASSWORD=${DB_PASSWORD:-webtest_default_pass_change_me}
      - DB_NAME=webtest
      - DB_MAX_OPEN_CONNS=25
      - DB_MAX_IDLE_CONNS=10
      # 应用配置
      - JWT_SECRET=${JWT_SECRET:-default_jwt_secret_please_change_in_production}
      - TZ=Asia/Shanghai
      # MCP 配置
      - MCP_AUTH_TOKEN=${MCP_AUTH_TOKEN:-default_mcp_token_change_me}
      - MCP_BACKEND_URL=https://localhost:8443
    volumes:
      # 持久化存储
      - ./storage:/app/storage
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - webtest-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8443/api/v1/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  # ---------------------------------------------------------------------------
  # PostgreSQL 数据库
  # ---------------------------------------------------------------------------
  postgres:
    image: postgres:16-alpine
    container_name: webtest-postgres
    restart: unless-stopped
    env_file:
      - .env
    environment:
      - POSTGRES_DB=webtest
      - POSTGRES_USER=webtest
      - POSTGRES_PASSWORD=${DB_PASSWORD:-webtest_default_pass_change_me}
      - TZ=Asia/Shanghai
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - webtest-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U webtest -d webtest"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

# -----------------------------------------------------------------------------
# 网络配置
# -----------------------------------------------------------------------------
networks:
  webtest-network:
    driver: bridge

# -----------------------------------------------------------------------------
# 数据卷配置
# -----------------------------------------------------------------------------
volumes:
  postgres_data:
    driver: local
